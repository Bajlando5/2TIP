<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>2TIP — Strona klasowa (Firestore)</title>
<link rel="icon" href="data:," />
<style>
  /* (CSS jak wcześniej - ciemny, fioletowo-niebieski motyw) */
  :root{
    --bg-0:#060714; --bg-1:#0f1724; --card: rgba(255,255,255,0.03);
    --glass: rgba(255,255,255,0.02); --accent1:#7c3aed; --accent2:#06b6d4;
    --text:#e6eef8; --muted:#98a0b3; --radius:12px; --shadow: 0 10px 30px rgba(2,6,23,0.6);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:
      radial-gradient(700px 500px at 10% 10%, rgba(124,58,237,0.09), transparent),
      radial-gradient(700px 500px at 90% 90%, rgba(6,182,212,0.06), transparent),
      linear-gradient(180deg,var(--bg-0),var(--bg-1));
    color:var(--text); display:flex;align-items:flex-start;justify-content:center;padding:28px;gap:20px;
  }
  .app { width:100%; max-width:1200px; display:grid; grid-template-columns:260px 1fr; gap:20px;
    background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
    border-radius:18px; box-shadow:var(--shadow); overflow:hidden; }
  aside{padding:20px;border-right:1px solid rgba(255,255,255,0.03)}
  .brand{display:flex;gap:12px;align-items:center;margin-bottom:14px}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent1),var(--accent2));
    display:flex;align-items:center;justify-content:center;font-weight:800;color:white;font-size:18px;box-shadow:0 8px 30px rgba(124,58,237,0.14);}
  nav ul{list-style:none;padding:0;margin:18px 0 0;display:flex;flex-direction:column;gap:10px}
  nav button{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;border:0;background:transparent;color:var(--text);cursor:pointer;font-weight:700;text-align:left;font-size:14px;}
  nav button:hover{background:rgba(255,255,255,0.02)} nav button.active{background:linear-gradient(90deg, rgba(124,58,237,0.18), rgba(6,182,212,0.08));box-shadow:inset 0 1px 0 rgba(255,255,255,0.02)}
  .status-card{margin-top:18px;padding:12px;border-radius:12px;background:var(--glass);border:1px solid rgba(255,255,255,0.02)}
  .small{font-size:13px;color:var(--muted)}
  main{padding:22px;overflow:auto}
  header.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
  .card{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow: inset 0 1px 0 rgba(255,255,255,0.01);margin-bottom:18px;}
  form{display:grid;gap:10px} input,select,textarea{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px;border-radius:10px;color:var(--text);outline:none}
  input:focus,textarea:focus,select:focus{border-color:rgba(124,58,237,0.6);box-shadow:0 8px 30px rgba(124,58,237,0.05)}
  .btn{display:inline-block;padding:10px 14px;border-radius:10px;border:0;font-weight:800;color:white;background:linear-gradient(90deg,var(--accent1),var(--accent2));cursor:pointer;transition:transform .12s ease,opacity .12s;}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)} .btn:hover{transform:translateY(-2px)}
  table{width:100%;border-collapse:collapse;margin-top:10px} th,td{padding:8px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:14px} th{color:var(--muted);font-weight:700;font-size:13px}
  .timetable{width:100%;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)} .timetable td[contenteditable]{cursor:text;background:rgba(255,255,255,0.01)} .timetable td:hover{background:rgba(255,255,255,0.01)}
  .admin-tabs{display:flex;gap:8px;margin-bottom:12px} .tab{padding:10px 12px;border-radius:10px;cursor:pointer;background:transparent;border:1px solid rgba(255,255,255,0.02);font-weight:700} .tab.active{background:linear-gradient(90deg, rgba(124,58,237,0.18), rgba(6,182,212,0.06))}
  .avatar{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;color:white;font-weight:800;overflow:hidden}
  .avatar img{width:100%;height:100%;object-fit:cover}
  @media (max-width:980px){ .app{grid-template-columns:1fr; padding:14px;} aside{order:2;border-right:0;border-top:1px solid rgba(255,255,255,0.03)}}
  body.theme-light{--bg-0:#f6f7fb; --bg-1:#eef2fb; --card:rgba(2,6,23,0.03); --text:#0b1220; --muted:#4b5563;}
</style>
</head>
<body>
<div class="app" role="application">
  <aside>
    <div class="brand">
      <div class="logo">2T</div>
      <div>
        <h1>2TIP — Klasa</h1>
        <p class="small">Panel uczniów i admina</p>
      </div>
    </div>

    <nav aria-label="Główna nawigacja">
      <ul>
        <li><button id="nav-login" class="active">Logowanie / Rejestracja</button></li>
        <li><button id="nav-timetable" style="display:none">Plan lekcji</button></li>
        <li><button id="nav-students" style="display:none">Uczniowie</button></li>
        <li><button id="nav-settings" style="display:none">Ustawienia</button></li>
        <li><button id="nav-admin" style="display:none">Panel administratora</button></li>
        <li><button id="nav-about" style="display:none">O klasie</button></li>
        <li><button id="nav-logout" style="display:none">Wyloguj</button></li>
      </ul>
    </nav>

    <div class="status-card card" id="status-box">
      <div class="small">Nie jesteś zalogowany</div>
    </div>
  </aside>

  <main>
    <header class="top">
      <div>
        <h2 class="title" id="page-title">Logowanie / Rejestracja</h2>
        <div class="subtitle" id="page-sub">Zaloguj się lub zarejestruj — admin zatwierdza nowe konta.</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <div id="welcome-text" class="small muted">Nie zalogowano</div>
        <div id="user-controls"></div>
      </div>
    </header>

    <!-- LOGIN + REGISTER -->
    <section id="panel-login" class="card">
      <div style="display:flex;gap:18px;flex-wrap:wrap">
        <div style="flex:1;min-width:260px">
          <h3>Logowanie</h3>
          <form id="form-login">
            <input id="login-username" placeholder="Nazwa użytkownika" required />
            <input id="login-password" type="password" placeholder="Hasło" required />
            <div style="display:flex;gap:8px;margin-top:6px">
              <button class="btn" type="submit">Zaloguj</button>
              <button class="btn ghost" type="button" id="btn-show-register">Rejestracja</button>
            </div>
            <div class="small muted" id="login-msg"></div>
          </form>
        </div>

        <div style="flex:1;min-width:260px">
          <h3>Rejestracja</h3>
          <form id="form-register">
            <input id="reg-username" placeholder="Nazwa użytkownika (unikalna)" required />
            <input id="reg-fullname" placeholder="Imię i nazwisko" required />
            <select id="reg-class">
              <option value="2TIP">2TIP</option>
            </select>
            <input id="reg-password" type="password" placeholder="Hasło (min 6 znaków)" required />
            <div style="display:flex;gap:8px;margin-top:6px">
              <button class="btn" type="submit">Zarejestruj</button>
              <button class="btn ghost" type="button" id="btn-clear-register">Wyczyść</button>
            </div>
            <div class="small muted" id="reg-msg" style="margin-top:6px"></div>
          </form>
        </div>
      </div>
      <div style="margin-top:12px" class="small muted">Po rejestracji konto będzie oczekiwać na zatwierdzenie przez administratora.</div>
    </section>

    <!-- TIMETABLE -->
    <section id="panel-timetable" class="card" style="display:none">
      <h3>Plan lekcji — 2TIP</h3>
      <div style="display:flex;gap:12px;align-items:flex-start">
        <div style="flex:1">
          <table class="timetable" id="timetable-table">
            <thead>
              <tr><th>Godz.</th><th>Pon</th><th>Wt</th><th>Śr</th><th>Czw</th><th>Pt</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div id="timetable-controls" style="width:320px">
          <div class="small muted">Edycja planu (tylko admin)</div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button class="btn" id="btn-add-row">Dodaj godzinę</button>
            <button class="btn ghost" id="btn-reset-timetable">Przywróć domyślny</button>
          </div>
          <div class="small muted" style="margin-top:10px">Kliknij komórkę aby edytować; zmiany zapisują się automatycznie.</div>
        </div>
      </div>
    </section>

    <!-- STUDENTS -->
    <section id="panel-students" class="card" style="display:none">
      <h3>Uczniowie</h3>
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
        <input id="search-students" placeholder="Szukaj po nazwie lub loginie" style="flex:1"/>
        <div class="small muted">Ilość uczniów: <span id="students-count">0</span></div>
      </div>
      <table id="students-table">
        <thead><tr><th>Awatar</th><th>Login</th><th>Imię i nazwisko</th><th>Klasa</th><th>Rola</th><th>Akcje</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- SETTINGS -->
    <section id="panel-settings" class="card" style="display:none">
      <h3>Ustawienia konta</h3>
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
        <div class="avatar" id="settings-avatar-preview">U</div>
        <div>
          <label class="small muted">Zmień awatar</label><br>
          <input id="avatar-file" type="file" accept="image/*">
          <div class="small muted">Plik max 2MB — zapis w Firestore Storage (opcjonalnie) lub jako base64 w dokumencie.</div>
        </div>
      </div>

      <div style="display:grid;gap:8px;max-width:520px">
        <label class="small muted">Imię i nazwisko</label>
        <input id="settings-fullname" placeholder="Imię i nazwisko">

        <label class="small muted">Zmień hasło</label>
        <input id="settings-current-pass" type="password" placeholder="Aktualne hasło">
        <input id="settings-new-pass" type="password" placeholder="Nowe hasło (min 6 znaków)">
        <div style="display:flex;gap:8px">
          <button class="btn" id="btn-change-pass">Zmień hasło</button>
          <button class="btn ghost" id="btn-reset-avatar">Resetuj awatar</button>
        </div>

        <label class="small muted">Motyw</label>
        <select id="settings-theme">
          <option value="default">Ciemny (domyślny)</option>
          <option value="light">Jasny</option>
        </select>
        <div style="display:flex;gap:8px">
          <button class="btn" id="btn-save-theme">Zapisz motyw</button>
          <button class="btn ghost" id="btn-reset-theme">Przywróć domyślny</button>
        </div>
        <div class="small muted" id="settings-msg"></div>
      </div>
    </section>

    <!-- ADMIN PANEL (same page, clean tabs) -->
    <section id="panel-admin" class="card" style="display:none">
      <h3>Panel administratora</h3>
      <div class="muted small">Szybkie zarządzanie klasą</div>

      <div style="margin-top:12px" class="admin-tabs">
        <div class="tab active" data-tab="admin-students-tab">📋 Uczniowie</div>
        <div class="tab" data-tab="admin-timetable-tab">🕒 Plan lekcji</div>
        <div class="tab" data-tab="admin-pending-tab">🔔 Powiadomienia</div>
      </div>

      <div id="admin-students-tab" class="admin-tab-content">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div class="small muted">Zarządzaj kontami uczniów</div>
          <div>
            <button class="btn" id="admin-add-sample">Dodaj przykładowe konto</button>
          </div>
        </div>
        <div class="card">
          <table id="admin-users-table">
            <thead><tr><th>Login</th><th>Imię</th><th>Klasa</th><th>Akcje</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="admin-timetable-tab" class="admin-tab-content" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div class="small muted">Edytuj plan lekcji dla klasy 2TIP</div>
          <div>
            <button class="btn" id="admin-save-timetable">Zapisz zmiany</button>
            <button class="btn ghost" id="admin-reset-timetable">Przywróć domyślny</button>
          </div>
        </div>
        <div class="card">
          <div class="small muted">Kliknij w komórkę by edytować, Enter aby zatwierdzić.</div>
          <div style="margin-top:10px">
            <table class="timetable" id="admin-timetable-table">
              <thead><tr><th>Godz.</th><th>Pon</th><th>Wt</th><th>Śr</th><th>Czw</th><th>Pt</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="admin-pending-tab" class="admin-tab-content" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div class="small muted">Nowe rejestracje oczekujące</div>
        </div>
        <div class="card">
          <div id="admin-pending-list"></div>
          <div class="small muted" id="admin-pending-empty" style="display:none">Brak oczekujących zgłoszeń.</div>
        </div>
      </div>
    </section>

    <!-- ABOUT -->
    <section id="panel-about" class="card" style="display:none">
      <h3>O klasie 2TIP</h3>
      <p class="muted">Tutaj możesz dodać opisy, linki do materiałów i terminarz wydarzeń.</p>
    </section>

  </main>
</div>

<!-- Firebase + App logic -->
<script type="module">
/* ========== Firebase initialization (modular SDK) ========== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, query, where, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyASvV16vCshSmD6p0EtP7G6y10ERwUuYbE",
  authDomain: "tip-28c08.firebaseapp.com",
  databaseURL: "https://tip-28c08-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "tip-28c08",
  storageBucket: "tip-28c08.firebasestorage.app",
  messagingSenderId: "710333813655",
  appId: "1:710333813655:web:8ca3443c682d6b8f302ad2",
  measurementId: "G-4ECL21HTZG"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ========== Helpers & local UI references ========== */
const $ = id => document.getElementById(id);
const nowISO = () => new Date().toISOString();

/* SHA-256 hashing (same as wcześniej) */
async function hashPassword(password){
  const enc = new TextEncoder();
  const data = enc.encode(password);
  const buf = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* ========== Firestore wrappers ========== */
// Collections: "users" (zatwierdzone konta, id = username), "pending" (oczekujące), "timetable" (jednostkowy dokument "2TIP")
async function loadUsersFirestore(){
  const q = query(collection(db, 'users'));
  const snap = await getDocs(q);
  return snap.docs.map(d => ({ id: d.id, ...d.data() }));
}
async function getUserByUsername(username){
  const d = await getDoc(doc(db,'users', username));
  return d.exists() ? { id:d.id, ...d.data() } : null;
}
async function saveUserFirestore(user){
  // user.username used as doc id
  await setDoc(doc(db,'users', user.username), user);
}
async function deleteUserFirestore(username){
  await deleteDoc(doc(db,'users', username));
}

// pending
async function addPendingFirestore(pendingObj){
  await addDoc(collection(db,'pending'), pendingObj);
}
async function loadPendingFirestore(){
  const snap = await getDocs(collection(db,'pending'));
  return snap.docs.map(d=>({ id:d.id, ...d.data() }));
}
async function deletePendingFirestore(docId){
  await deleteDoc(doc(db,'pending', docId));
}

// timetable (single doc id "2TIP")
async function loadTimetableFirestore(){
  const d = await getDoc(doc(db,'timetable','2TIP'));
  return d.exists() ? d.data() : null;
}
async function saveTimetableFirestore(obj){
  await setDoc(doc(db,'timetable','2TIP'), obj);
}

/* ========== Default data setup ========== */
const defaultTimetable = {
  slots: [
    {time:'8:00-8:45', pon:'J. polski', wt:'Matematyka', sr:'Fizyka', czw:'WF', pt:'Informatyka'},
    {time:'8:55-9:40', pon:'Matematyka', wt:'J. angielski', sr:'Chemia', czw:'BHP', pt:'Historia'},
    {time:'9:50-10:35', pon:'Informatyka', wt:'Fizyka', sr:'J. polski', czw:'Matematyka', pt:'Technologia'},
    {time:'10:55-11:40', pon:'WF', wt:'Historia', sr:'J. angielski', czw:'Geografia', pt:'Biologia'}
  ]
};

async function ensureDefaultTimetable(){
  const tt = await loadTimetableFirestore();
  if(!tt) await saveTimetableFirestore(defaultTimetable);
}

/* ========== Ensure default admin user exists in Firestore ========== */
async function ensureDefaultAdmin(){
  const admin = await getUserByUsername('admin');
  if(!admin){
    const ph = await hashPassword('Admin!234');
    const adminObj = {
      username: 'admin',
      fullname: 'Administrator',
      class: 'admin',
      isAdmin: true,
      passwordHash: ph,
      avatarData: null,
      theme: 'default',
      createdAt: nowISO()
    };
    await saveUserFirestore(adminObj);
  }
}

/* ========== Session (kept in sessionStorage for UI) ========== */
let currentUser = null;
function saveSession(username){
  if(username) sessionStorage.setItem('2tip_session_v2', JSON.stringify({ username }));
  else sessionStorage.removeItem('2tip_session_v2');
}
async function loadSession(){
  try{
    const s = sessionStorage.getItem('2tip_session_v2');
    if(!s) return;
    const obj = JSON.parse(s);
    if(obj && obj.username){
      const u = await getUserByUsername(obj.username);
      if(u) currentUser = u;
    }
  }catch(e){}
}

/* ========== UI helpers ========== */
const navLogin = $('nav-login'), navTimetable = $('nav-timetable'), navStudents = $('nav-students'), navSettings = $('nav-settings'), navAdmin = $('nav-admin'), navAbout = $('nav-about'), navLogout = $('nav-logout');
const panelLogin = $('panel-login'), panelTimetable = $('panel-timetable'), panelStudents = $('panel-students'), panelSettings = $('panel-settings'), panelAdmin = $('panel-admin'), panelAbout = $('panel-about');

function setActiveNav(btn){ document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active')); if(btn) btn.classList.add('active'); }
function hideAllPanels(){ [panelLogin, panelTimetable, panelStudents, panelSettings, panelAdmin, panelAbout].forEach(p=>p&&(p.style.display='none')); }
function showPanel(panel){ hideAllPanels(); panel.style.display='block'; }

/* Update nav visible based on currentUser */
async function updateNavVisibility(){
  const logged = !!currentUser;
  navLogin.style.display = logged ? 'none' : 'block';
  navTimetable.style.display = logged ? 'block' : 'none';
  navStudents.style.display = logged ? 'block' : 'none';
  navSettings.style.display = logged ? 'block' : 'none';
  navAbout.style.display = logged ? 'block' : 'none';
  navLogout.style.display = logged ? 'block' : 'none';
  navAdmin.style.display = (logged && currentUser && currentUser.isAdmin) ? 'block' : 'none';
  updateStatusCard();
  renderStudents(); updateAdminPendingCount();
}

/* Status card & userControls */
function updateStatusCard(){
  const statusBox = $('status-box'); statusBox.innerHTML = '';
  const welcomeText = $('welcome-text'); const userControls = $('user-controls');
  userControls.innerHTML = '';
  if(currentUser){
    const wrapper = document.createElement('div'); wrapper.style.display='flex'; wrapper.style.gap='10px'; wrapper.style.alignItems='center';
    const avat = document.createElement('div'); avat.className='avatar';
    if(currentUser.avatarData){ const img = document.createElement('img'); img.src = currentUser.avatarData; avat.appendChild(img); } else { avat.textContent = (currentUser.fullname||currentUser.username||'U').slice(0,2).toUpperCase(); }
    wrapper.appendChild(avat);
    const txt = document.createElement('div'); txt.innerHTML = `<div style="font-weight:700">${currentUser.fullname || currentUser.username}</div><div class="small muted">${currentUser.username} · ${currentUser.class}</div>`;
    wrapper.appendChild(txt);
    statusBox.appendChild(wrapper);

    welcomeText.textContent = `Witaj, ${currentUser.fullname || currentUser.username}`;
    const logoutBtn = document.createElement('button'); logoutBtn.className='btn ghost'; logoutBtn.textContent='Wyloguj';
    logoutBtn.onclick = ()=>{ currentUser = null; saveSession(null); updateNavVisibility(); showPanel(panelLogin); setActiveNav(navLogin); };
    userControls.appendChild(logoutBtn);

    if(currentUser.isAdmin){
      const adminBtn = document.createElement('button'); adminBtn.className='btn'; adminBtn.textContent='Panel admina';
      adminBtn.onclick = ()=>{ setActiveNav(navAdmin); showPanel(panelAdmin); openAdminTab('admin-students-tab'); };
      userControls.appendChild(adminBtn);
    }

    // apply theme
    if(currentUser.theme && currentUser.theme === 'light'){ document.body.classList.add('theme-light'); } else { document.body.classList.remove('theme-light'); }
  } else {
    statusBox.innerHTML = '<div class="small">Nie jesteś zalogowany</div>';
    welcomeText.textContent = 'Nie zalogowano';
    document.body.classList.remove('theme-light');
  }
}

/* ========== FORM HANDLERS: login / register ========== */
$('form-login').addEventListener('submit', async (e)=>{
  e.preventDefault();
  $('login-msg').textContent = '';
  const user = $('login-username').value.trim();
  const pass = $('login-password').value;
  if(!user || !pass){ $('login-msg').textContent = 'Wypełnij pola.'; return; }
  try{
    const found = await getUserByUsername(user);
    if(!found){ $('login-msg').textContent = 'Nie znaleziono użytkownika (może oczekuje na zatwierdzenie).'; return; }
    const ph = await hashPassword(pass);
    if(ph !== found.passwordHash){ $('login-msg').textContent = 'Błędne hasło.'; return; }
    currentUser = found;
    saveSession(currentUser.username);
    $('login-password').value='';
    updateNavVisibility();
    setActiveNav(navTimetable);
    showPanel(panelTimetable);
    renderTimetable();
  }catch(err){
    console.error(err); $('login-msg').textContent = 'Błąd logowania.'; 
  }
});

$('form-register').addEventListener('submit', async (e)=>{
  e.preventDefault();
  $('reg-msg').textContent = '';
  const username = $('reg-username').value.trim();
  const fullname = $('reg-fullname').value.trim();
  const klass = $('reg-class').value;
  const pass = $('reg-password').value;
  if(!username || !fullname || !pass){ $('reg-msg').textContent = 'Uzupełnij wszystkie pola.'; return; }
  if(pass.length < 6){ $('reg-msg').textContent = 'Hasło musi mieć min 6 znaków.'; return; }
  try{
    const existing = await getUserByUsername(username);
    const pending = await loadPendingFirestore();
    if(existing || pending.some(p=>p.username.toLowerCase()===username.toLowerCase())){ $('reg-msg').textContent = 'Nazwa użytkownika zajęta lub oczekuje.'; return; }
    const ph = await hashPassword(pass);
    await addPendingFirestore({ username, fullname, class: klass, passwordHash: ph, createdAt: nowISO() });
    $('reg-msg').textContent = 'Zarejestrowano — konto oczekuje na zatwierdzenie.';
    $('form-register').reset();
    renderAdminPending(); updatePendingBadge();
  }catch(err){
    console.error(err); $('reg-msg').textContent = 'Błąd rejestracji.';
  }
});

$('btn-clear-register').addEventListener('click', ()=>{ $('reg-username').value=''; $('reg-fullname').value=''; $('reg-password').value=''; $('reg-msg').textContent=''; });
$('btn-show-register').addEventListener('click', ()=>{ $('reg-username').focus(); });

/* ========== TIMETABLE rendering (user) ========== */
async function renderTimetable(){
  const tb = $('timetable-table'); if(!tb) return;
  const body = tb.querySelector('tbody'); body.innerHTML = '';
  let t = await loadTimetableFirestore();
  if(!t){ await saveTimetableFirestore(defaultTimetable); t = defaultTimetable; }
  t.slots.forEach(slot=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${slot.time}</td><td>${slot.pon}</td><td>${slot.wt}</td><td>${slot.sr}</td><td>${slot.czw}</td><td>${slot.pt}</td>`;
    body.appendChild(tr);
  });
  // show edit controls only for admin
  const controls = $('timetable-controls');
  if(currentUser && currentUser.isAdmin) controls.style.display='block'; else controls.style.display='none';
}

/* ========== ADMIN: editable timetable ========== */
async function renderAdminTimetable(){
  const table = $('admin-timetable-table'); const body = table.querySelector('tbody'); body.innerHTML = '';
  const t = await loadTimetableFirestore() || defaultTimetable;
  t.slots.forEach((slot, rowIdx)=>{
    const tr = document.createElement('tr');
    const tdTime = document.createElement('td'); tdTime.textContent = slot.time; tr.appendChild(tdTime);
    ['pon','wt','sr','czw','pt'].forEach(dayKey=>{
      const td = document.createElement('td');
      td.textContent = slot[dayKey] || '';
      td.setAttribute('contenteditable','true');
      td.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter'){ ev.preventDefault(); ev.target.blur(); } });
      td.addEventListener('blur', ()=> saveAdminTimetableFromTable());
      tr.appendChild(td);
    });
    body.appendChild(tr);
  });
}
async function saveAdminTimetableFromTable(){
  const table = $('admin-timetable-table'); if(!table) return;
  const body = table.querySelector('tbody');
  const newSlots = [];
  for(let i=0;i<body.rows.length;i++){
    const r = body.rows[i];
    const cols = Array.from(r.cells).map(c=>c.textContent.trim());
    newSlots.push({ time: cols[0] || '', pon: cols[1]||'', wt: cols[2]||'', sr: cols[3]||'', czw: cols[4]||'', pt: cols[5]||'' });
  }
  await saveTimetableFirestore({ slots: newSlots });
  await renderTimetable();
}

/* Timetable controls */
$('btn-add-row').addEventListener('click', async ()=>{
  if(!currentUser || !currentUser.isAdmin){ alert('Tylko admin.'); return; }
  const t = await loadTimetableFirestore() || defaultTimetable;
  t.slots.push({ time:'nowa', pon:'', wt:'', sr:'', czw:'', pt:'' });
  await saveTimetableFirestore(t); await renderTimetable(); await renderAdminTimetable();
});
$('btn-reset-timetable').addEventListener('click', async ()=>{
  if(!confirm('Przywrócić domyślny plan lekcji?')) return;
  await saveTimetableFirestore(defaultTimetable); await renderTimetable(); await renderAdminTimetable();
});
$('admin-save-timetable').addEventListener('click', async ()=>{ await saveAdminTimetableFromTable(); alert('Plan zapisany.'); });
$('admin-reset-timetable').addEventListener('click', async ()=>{ if(confirm('Przywrócić domyślny plan?')){ await saveTimetableFirestore(defaultTimetable); await renderAdminTimetable(); await renderTimetable(); alert('Przywrócono.'); } });

/* ========== Students listing ========== */
async function renderStudents(filter=''){
  const tbody = $('students-table').querySelector('tbody'); tbody.innerHTML = '';
  const users = await loadUsersFirestore();
  const filtered = users.filter(u => !u.isAdmin && (u.username + ' ' + (u.fullname||'')).toLowerCase().includes(filter.toLowerCase()));
  filtered.forEach(u=>{
    const tr = document.createElement('tr');
    const tdAvatar = document.createElement('td');
    const avat = document.createElement('div'); avat.className='avatar';
    if(u.avatarData){ const img = document.createElement('img'); img.src = u.avatarData; avat.appendChild(img);} else { avat.textContent = (u.fullname || u.username).slice(0,2).toUpperCase(); }
    tdAvatar.appendChild(avat); tr.appendChild(tdAvatar);
    tr.insertCell().textContent = u.username; tr.insertCell().textContent = u.fullname || '-'; tr.insertCell().textContent = u.class || '-';
    tr.insertCell().textContent = u.isAdmin ? 'Admin' : 'Uczeń';
    const actions = tr.insertCell();
    const btnView = document.createElement('button'); btnView.className='btn ghost'; btnView.textContent='Szczegóły';
    btnView.onclick = ()=> { alert(`Login: ${u.username}\nImię: ${u.fullname}\nKlasa: ${u.class}\nUtworzono: ${u.createdAt}`); };
    actions.appendChild(btnView);
    if(currentUser && currentUser.isAdmin){
      if(u.username !== 'admin'){
        const btnReset = document.createElement('button'); btnReset.className='btn'; btnReset.textContent='Resetuj hasło';
        btnReset.onclick = async ()=>{ const np = prompt('Nowe hasło (min 6 zn.):'); if(!np) return; if(np.length<6){ alert('Za krótkie.'); return;} const ph = await hashPassword(np); const us = await loadUsersFirestore(); const userObj = us.find(x=>x.username===u.username); userObj.passwordHash = ph; await saveUserFirestore(userObj); alert('Hasło zresetowane.'); };
        const btnDelete = document.createElement('button'); btnDelete.className='btn'; btnDelete.style.background='linear-gradient(90deg,#ef4444,#f97316)'; btnDelete.textContent='Usuń';
        btnDelete.onclick = async ()=>{ if(confirm(`Usunąć konto ${u.username}?`)){ await deleteUserFirestore(u.username); await renderStudents(); await updateAdminUsersTable(); alert('Usunięto'); } };
        actions.appendChild(btnReset); actions.appendChild(btnDelete);
      }
    }
    tbody.appendChild(tr);
  });
  $('students-count').textContent = (await loadUsersFirestore()).filter(u=>!u.isAdmin).length;
}
$('search-students').addEventListener('input', (e)=> renderStudents(e.target.value));

/* ========== Settings (avatar upload stored as base64 in users doc for simplicity) ========== */
$('avatar-file').addEventListener('change', (e)=>{
  const file = e.target.files[0]; if(!file) return;
  if(file.size > 2 * 1024 * 1024){ alert('Plik za duży (max 2MB)'); return; }
  const reader = new FileReader();
  reader.onload = async function(ev){
    const data = ev.target.result;
    const u = await getUserByUsername(currentUser.username);
    if(u){ u.avatarData = data; await saveUserFirestore(u); currentUser = u; updateStatusCard(); populateSettings(); renderStudents(); updateAdminUsersTable(); }
  };
  reader.readAsDataURL(file);
});
$('btn-reset-avatar').addEventListener('click', async ()=>{
  if(!confirm('Resetować awatar?')) return;
  const u = await getUserByUsername(currentUser.username); if(u){ u.avatarData = null; await saveUserFirestore(u); currentUser = u; updateStatusCard(); populateSettings(); renderStudents(); }
});
$('btn-change-pass').addEventListener('click', async ()=>{
  const cur = $('settings-current-pass').value; const nw = $('settings-new-pass').value;
  if(!cur || !nw){ $('settings-msg').textContent = 'Wypełnij pola.'; return; } if(nw.length<6){ $('settings-msg').textContent='Hasło min 6 znaków.'; return; }
  const phcur = await hashPassword(cur);
  if(phcur !== currentUser.passwordHash){ $('settings-msg').textContent='Błędne aktualne hasło.'; return; }
  const newHash = await hashPassword(nw); const u = await getUserByUsername(currentUser.username); u.passwordHash = newHash; await saveUserFirestore(u); currentUser = u; $('settings-current-pass').value=''; $('settings-new-pass').value=''; $('settings-msg').textContent='Hasło zmienione.'; alert('Hasło zmienione.');
});
$('btn-save-theme').addEventListener('click', async ()=>{
  const sel = $('settings-theme').value; const u = await getUserByUsername(currentUser.username); u.theme = sel; await saveUserFirestore(u); currentUser = u; if(sel==='light') document.body.classList.add('theme-light'); else document.body.classList.remove('theme-light'); alert('Motyw zapisany.');
});
$('btn-reset-theme').addEventListener('click', async ()=>{ const u = await getUserByUsername(currentUser.username); u.theme='default'; await saveUserFirestore(u); currentUser = u; document.body.classList.remove('theme-light'); $('settings-theme').value='default'; alert('Przywrócono motyw.'); });

function populateSettings(){
  if(!currentUser) return;
  $('settings-fullname').value = currentUser.fullname || '';
  const prev = $('settings-avatar-preview'); prev.innerHTML = '';
  if(currentUser.avatarData){ const img = document.createElement('img'); img.src = currentUser.avatarData; prev.appendChild(img); } else { prev.textContent = (currentUser.fullname||currentUser.username||'U').slice(0,2).toUpperCase(); }
  $('settings-theme').value = currentUser.theme || 'default';
  $('settings-msg').textContent = '';
}

/* ========== Admin UIs (users, pending, timetable) ========== */
async function updateAdminUsersTable(){
  const tbody = $('admin-users-table').querySelector('tbody'); tbody.innerHTML = '';
  const users = await loadUsersFirestore();
  users.forEach(u=>{
    const tr = document.createElement('tr');
    tr.insertCell().textContent = u.username; tr.insertCell().textContent = u.fullname || '-'; tr.insertCell().textContent = u.class || '-';
    const actions = tr.insertCell();
    const btnReset = document.createElement('button'); btnReset.className='btn'; btnReset.textContent='Reset hasła';
    btnReset.onclick = async ()=>{ const np = prompt('Nowe hasło (min 6):'); if(!np) return; if(np.length<6){ alert('Za krótkie'); return;} u.passwordHash = await hashPassword(np); await saveUserFirestore(u); alert('Hasło zresetowane.'); updateAdminUsersTable(); };
    actions.appendChild(btnReset);
    if(u.username !== 'admin'){
      const btnDel = document.createElement('button'); btnDel.className='btn'; btnDel.style.background='linear-gradient(90deg,#ef4444,#f97316)'; btnDel.textContent='Usuń';
      btnDel.onclick = async ()=>{ if(confirm(`Usunąć konto ${u.username}?`)){ await deleteUserFirestore(u.username); updateAdminUsersTable(); renderStudents(); alert('Usunięto'); } };
      actions.appendChild(btnDel);
    }
    tbody.appendChild(tr);
  });
}

/* Pending list */
async function renderAdminPending(){
  const list = $('admin-pending-list'); list.innerHTML = '';
  const pending = await loadPendingFirestore();
  if(pending.length === 0){ $('admin-pending-empty').style.display='block'; return; } else { $('admin-pending-empty').style.display='none'; }
  pending.forEach(p=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='10px'; row.style.borderRadius='8px'; row.style.marginBottom='8px'; row.style.background='rgba(255,255,255,0.01)';
    const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:700">${p.fullname} <span class="small muted">(${p.username})</span></div><div class="small muted">Klasa: ${p.class} · ${new Date(p.createdAt).toLocaleString()}</div>`;
    const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px';
    const btnA = document.createElement('button'); btnA.className='btn'; btnA.textContent='Zatwierdź';
    btnA.onclick = async ()=>{ await approvePending(p.id); };
    const btnR = document.createElement('button'); btnR.className='btn ghost'; btnR.textContent='Odrzuć';
    btnR.onclick = async ()=>{ await rejectPending(p.id); };
    right.appendChild(btnA); right.appendChild(btnR);
    row.appendChild(left); row.appendChild(right);
    list.appendChild(row);
  });
}
async function approvePending(docId){
  const pendingSnap = await getDoc(doc(db,'pending', docId));
  if(!pendingSnap.exists()){ alert('Nie znaleziono zgłoszenia.'); return; }
  const p = pendingSnap.data();
  // create user with username as doc id
  const newUser = {
    username: p.username,
    fullname: p.fullname,
    class: p.class || '2TIP',
    isAdmin: false,
    passwordHash: p.passwordHash,
    avatarData: null,
    theme: 'default',
    createdAt: nowISO()
  };
  await saveUserFirestore(newUser);
  await deletePendingFirestore(docId);
  await renderAdminPending(); await updateAdminUsersTable(); await renderStudents(); alert('Konto zatwierdzone.');
}
async function rejectPending(docId){
  if(!confirm('Odrzucić zgłoszenie?')) return;
  await deletePendingFirestore(docId);
  await renderAdminPending(); updatePendingBadge(); alert('Odrzucono zgłoszenie.');
}

async function updatePendingBadge(){
  const pending = await loadPendingFirestore();
  // not showing badge in nav, but admin panel shows list/empty message
  $('admin-pending-empty').style.display = pending.length ? 'none' : 'block';
}
async function updateAdminPendingCount(){ await updatePendingBadge(); }

/* Admin sample user */
$('admin-add-sample').addEventListener('click', async ()=>{
  const username = 'uczen' + (Math.floor(Math.random()*900)+100);
  const ph = await hashPassword('haslo123');
  const newUser = { username, fullname:'Jan Sample', class:'2TIP', isAdmin:false, passwordHash:ph, avatarData:null, theme:'default', createdAt: nowISO() };
  await saveUserFirestore(newUser);
  await updateAdminUsersTable(); await renderStudents(); alert('Dodano próbne konto: ' + username + ' / haslo: haslo123');
});

/* Admin tab switching */
document.querySelectorAll('.admin-tabs .tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    document.querySelectorAll('.admin-tabs .tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    const key = tab.dataset.tab;
    openAdminTab(key);
  });
});
function openAdminTab(key){
  document.querySelectorAll('.admin-tab-content').forEach(c=>c.style.display='none');
  const el = $(key);
  if(el) el.style.display='block';
  if(key === 'admin-students-tab') updateAdminUsersTable();
  if(key === 'admin-timetable-tab') renderAdminTimetable();
  if(key === 'admin-pending-tab') renderAdminPending();
}

/* ========== Real-time updates (onSnapshot) ==========
   - Updates admin pending list and users list in realtime across tabs
*/
onSnapshot(collection(db,'pending'), snap => { renderAdminPending(); updatePendingBadge(); });
onSnapshot(collection(db,'users'), snap => { updateAdminUsersTable(); renderStudents(); updateNavVisibility(); });

/* ========== Initialization sequence ========== */
await ensureDefaultAdmin();
await ensureDefaultTimetable();
await loadSession(); // restore session if present
await updateNavVisibility();
if(currentUser){ showPanel(panelTimetable); setActiveNav(navTimetable); renderTimetable(); } else { showPanel(panelLogin); setActiveNav(navLogin); }

/* ========== Expose some helpers for debugging in console ========== */
window._2TIP = { loadUsersFirestore, loadPendingFirestore, loadTimetableFirestore, saveTimetableFirestore };

</script>
</body>
</html>
